å¥½ï¼Œè¿™ä¸€å¥è¯å…¶å®å·²ç»**æŠŠè®¾è®¡å®šæ­»äº†** ğŸ‘
æˆ‘ç°åœ¨å°±**å®Œå…¨æŒ‰ä½ è¿™æ¡åŸåˆ™**æ¥æ”¶æ•›æ–¹æ¡ˆï¼Œä¸å†å¼•å…¥ diet / åå¥½ / rerank / meal_time ç­‰å¤æ‚åº¦ã€‚

> **æœ€ç»ˆåŸåˆ™ï¼ˆMVP å®šç‰ˆï¼‰**
> âœ… ä»¥ã€Œç›®å½•ç±»ç›®ã€ä¸ºå”¯ä¸€çº¦æŸæ¥æº
> âœ… ç±»ç›®ä¸€å¾‹ **ç¡¬è¿‡æ»¤**
> âœ… å‘½ä¸­å¤šä¸ªç±»ç›® â†’ **æ¾„æ¸…ï¼ˆGOOD_BUT_AMBIGUOUSï¼‰**
> âŒ ä¸åš soft / rerank
> âŒ ä¸åš diet / category åŒºåˆ†
> âŒ ä¸åšè¡¨è¾¾æ–¹å¼åˆ¤æ–­

ä¸‹é¢æ˜¯**ä¸€ä»½å¯ä»¥ç›´æ¥ç…§ç€å®ç°çš„ã€å®Œæ•´ä¸”ç®€åŒ–çš„å¯æ‰§è¡Œæ­¥éª¤**ã€‚

---

# æœ€ç»ˆæ‰§è¡Œæ–¹æ¡ˆï¼ˆç›®å½•ç±»ç›®ç¡¬è¿‡æ»¤ + å¤šå‘½ä¸­æ¾„æ¸…ï¼‰

## ä¸€ã€æ ¸å¿ƒè®¾è®¡ç›®æ ‡ï¼ˆå¯¹é½ï¼‰

1. **è¡Œä¸ºå¯é¢„æµ‹**ï¼šç”¨æˆ·è¯´ä»€ä¹ˆç±»ç›®ï¼Œå°±åªè¿”å›é‚£ä¸ªç±»ç›®
2. **ç»ä¸å·æ¢è¯­ä¹‰**ï¼šè¦æ±¤ä¸è¿”å›é¥®æ–™ï¼Œè¦ç´ èœä¸è¿”å›è¤èœ
3. **è§„åˆ™æå°‘**ï¼šåªæœ‰ã€Œæ˜ å°„ + ç¡¬è¿‡æ»¤ + æ¾„æ¸…ã€
4. **å¤±è´¥å¯è§£é‡Š**ï¼šè¦ä¹ˆæœ‰ç»“æœï¼Œè¦ä¹ˆæ˜ç¡®æ¾„æ¸…

---

## äºŒã€ç›®å½•ä½œä¸ºå”¯ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰

### ä½ çš„ç›®å½•ç»“æ„ï¼ˆç¤ºä¾‹ï¼‰

```
dishes/
â”œâ”€â”€ ç´ èœ
â”œâ”€â”€ è¤èœ
â”œâ”€â”€ æ°´äº§
â”œâ”€â”€ æ±¤
â”œâ”€â”€ ç”œç‚¹
â”œâ”€â”€ é¥®æ–™
â”œâ”€â”€ æ—©é¤
â”œâ”€â”€ ä¸»é£Ÿ
â”œâ”€â”€ åŠæˆå“
â”œâ”€â”€ è°ƒæ–™
â”œâ”€â”€ ç¤ºä¾‹èœ
```

> **è¿™å°±æ˜¯ä½ çš„ ontologyï¼Œä¸å†å¼•å…¥ç¬¬äºŒå¥—æ¦‚å¿µä½“ç³»**

---

## ä¸‰ã€ç´¢å¼•é˜¶æ®µï¼ˆå¿…é¡»åšï¼Œä¸€æ¬¡æ€§ï¼‰

### Step 1ï¼šä»è·¯å¾„æå– category_primary

å¯¹æ¯ä¸ªèœè°± parentï¼ˆmd æ–‡ä»¶ï¼‰ï¼š

```text
data/.../dishes/æ±¤/xxx.md  â†’ category_primary = "æ±¤"
```

### Step 2ï¼šæ ‡è®°é»˜è®¤æ’é™¤ç±»ç›®

ä»¥ä¸‹ç±»ç›®**é»˜è®¤ä¸å‚ä¸â€œæ¨èèœè°±â€**ï¼š

* ç¤ºä¾‹èœ
* è°ƒæ–™
* åŠæˆå“

ç´¢å¼•æ—¶å†™å…¥ï¼š

```json
{
  "category_primary": "è°ƒæ–™",
  "is_excluded_default": true
}
```

---

## å››ã€Query è§£æï¼ˆåªåšä¸€ä»¶äº‹ï¼‰

### Step 3ï¼šç±»ç›®åŒä¹‰è¯ â†’ ç›®å½•ç±»ç›® æ˜ å°„

ç»´æŠ¤ä¸€å¼ **å°è€Œç¨³å®š**çš„æ˜ å°„è¡¨ï¼š

```python
CATEGORY_SYNONYMS = {
    "ç´ èœ": ["ç´ ", "ç´ èœ", "ç´ é£Ÿ", "æ— è‚‰"],
    "è¤èœ": ["è¤", "è¤èœ", "è‚‰", "è‚‰èœ", "æœ‰è‚‰"],
    "æ°´äº§": ["æ°´äº§", "æµ·é²œ", "é±¼", "è™¾", "èŸ¹"],
    "æ±¤": ["æ±¤", "ç¾¹", "ç…²æ±¤"],
    "ç”œç‚¹": ["ç”œç‚¹", "ç”œå“", "ç‚¹å¿ƒ"],
    "é¥®æ–™": ["é¥®æ–™", "é¥®å“", "å¥¶èŒ¶", "æœæ±"],
    "æ—©é¤": ["æ—©é¤", "æ—©é¥­", "æ—©ç‚¹"],
    "ä¸»é£Ÿ": ["ä¸»é£Ÿ", "é¥­", "é¢", "ç²¥", "é¥¼"],
}
```

### Step 4ï¼šæ£€æµ‹å‘½ä¸­å“ªäº›ç›®å½•ç±»ç›®

```python
def detect_categories(query: str) -> Set[str]:
    hits = set()
    for category, words in CATEGORY_SYNONYMS.items():
        if any(w in query for w in words):
            hits.add(category)
    return hits
```

---

## äº”ã€æ ¸å¿ƒå†³ç­–é€»è¾‘ï¼ˆéå¸¸ç®€å•ï¼‰

### Case 1ï¼šæœªå‘½ä¸­ä»»ä½•ç±»ç›®

```text
â†’ ä¸åšç±»ç›®è¿‡æ»¤
â†’ èµ°ä½ åŸæœ‰çš„æ£€ç´¢ / coverage / overall_score / çŠ¶æ€æœº
```

---

### Case 2ï¼šå‘½ä¸­ **1 ä¸ªç±»ç›®**

```text
â†’ ç¡¬è¿‡æ»¤ category_primary == å‘½ä¸­ç±»ç›®
â†’ åŒæ—¶æ’é™¤ is_excluded_default=true
```

* è‹¥è¿‡æ»¤å **æœ‰ç»“æœ**ï¼š

  * æ­£å¸¸è¿›å…¥ AUTO / AMBIG / LOW åˆ¤å®š
* è‹¥è¿‡æ»¤å **æ— ç»“æœ**ï¼š

  * LOW_EVIDENCE
  * clarify_questionï¼š

    > â€œå½“å‰æ²¡æœ‰ã€æ±¤ã€‘ç±»èœè°±ï¼Œè¦ä¸è¦çœ‹çœ‹ã€ç¾¹ / ç‚–èœ / ç´ èœã€‘ï¼Ÿâ€

ğŸ‘‰ **ä¸é™çº§ã€ä¸æ··ç±»ç›®**

---

### Case 3ï¼šå‘½ä¸­ **å¤šä¸ªç±»ç›®**

ä¾‹å¦‚ï¼š

* â€œç´ æ±¤â€ â†’ å‘½ä¸­ {ç´ èœ, æ±¤}
* â€œæ—©é¤ä¸»é£Ÿâ€ â†’ å‘½ä¸­ {æ—©é¤, ä¸»é£Ÿ}

```text
â†’ GOOD_BUT_AMBIGUOUS
â†’ parent_lock = pending
â†’ è¿”å›å€™é€‰ç±»ç›®åˆ—è¡¨
```

ç¤ºä¾‹è¿”å›ï¼š

```json
{
  "state": "GOOD_BUT_AMBIGUOUS",
  "pending_categories": ["ç´ èœ", "æ±¤"],
  "clarify_question": "ä½ æ˜¯æƒ³çœ‹ã€ç´ èœã€‘è¿˜æ˜¯ã€æ±¤ã€‘ï¼Ÿ"
}
```

> **ä¸è‡ªåŠ¨ç»„åˆã€ä¸çŒœã€ä¸é™çº§**

---

## å…­ã€ç”¨æˆ·æ¾„æ¸…åçš„å¤„ç†

### Step 5ï¼šç”¨æˆ·é€‰æ‹©ç±»ç›®

ä¾‹å¦‚ç”¨æˆ·å›å¤ï¼š

* â€œæ±¤â€
* æˆ– option_id = 2

```text
â†’ åªä¿ç•™ category_primary == ç”¨æˆ·é€‰æ‹©
â†’ è¿›å…¥æ­£å¸¸æ£€ç´¢ / è¯„åˆ† / parent locking
```

---

## ä¸ƒã€å’Œä½ ç°æœ‰ç³»ç»Ÿçš„å¯¹é½ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰

è¿™ä¸ªæ–¹æ¡ˆ **ä¸ç ´åä½ å·²æœ‰çš„ä»»ä½•æ ¸å¿ƒæœºåˆ¶**ï¼š

* coverage_ratio é—¨æ§› âœ…
* rrf_sum / max_score / overall_score âœ…
* AUTO / GOOD_BUT_AMBIGUOUS / LOW_EVIDENCE çŠ¶æ€æœº âœ…
* Parent Locking / Evidence-Driven Generation âœ…
* Session / pending_candidates âœ…

å®ƒåªæ˜¯**åœ¨æ£€ç´¢èšåˆå‰åŠ äº†ä¸€é“â€œç±»ç›®ç¡¬è¿‡æ»¤ or æ¾„æ¸…â€çš„é—¸é—¨**ã€‚

---

## å…«ã€å¿…é¡»è¡¥çš„æ—¥å¿—ï¼ˆå¦åˆ™ä½ æ²¡æ³•éªŒè¯ï¼‰

åœ¨ retriever / decision log ä¸­æ–°å¢ï¼š

```json
{
  "detected_categories": ["æ±¤"],
  "category_filter_applied": true,
  "category_conflict": false,
  "category_filtered_count": 7
}
```

æˆ–å¤šå‘½ä¸­æ—¶ï¼š

```json
{
  "detected_categories": ["ç´ èœ", "æ±¤"],
  "category_conflict": true,
  "state": "GOOD_BUT_AMBIGUOUS"
}
```

